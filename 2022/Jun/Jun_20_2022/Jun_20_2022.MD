# NoteS FOR JUN_20_2022

This is a note or a diary for the things I research in a day, this note intended for me not to forget the knowlegde I has gain (or things I has read).

## Logstash TLS Secure Connection with Elasticsearch

In this case you need to change the password for the built-in user (which is logstash_system) and create a user that has the permission to modfiy index and write to it

### How to do

1. You need to start the system up the Elasticsearch and the Kibana first
2. You will go to the UI Kibana and then start create user name **logstash_writer** and **logstash_writer_role** withe the permission to use ILM and
stuff (refs: <https://www.elastic.co/blog/configuring-ssl-tls-and-https-to-secure-elasticsearch-kibana-beats-and-logstash>)
3. Take the password and the username you just created and then go to logstash config file and add these line

```yml

elasticsearch {
    // host will be the the elastic host and stuff
    hosts => ["es01:9200","es02:9200","es03:9200"]
    ssl => true
    user => <username - logstash_writer>
    password => <password>
    cacert => "config/certs/ca/ca.crt"
    codec => plain { charset=>"UTF-8" }
}

```

4. After that you should check the cacert is correct if you not using docker like me then you should have copy the cert that was generated by logstash
5. The config on the docker-compose.yml will look like this

LOGSTASH_PASSWORD is must the same as you config in the Kibana UI - Managment - User (logstash_system user)

```yml
  environment:
      - QUEUE_MAXBYTES=4gb
      - XPACK_MONITORING_ENABLED="true"
      - XPACK_MONITORING_ELASTICSEARCH_HOSTS=["es01:9200","es02:9200","es03:9200"]
      - XPACK_MONITORING_ELASTICSEARCH_USERNAME= logstash_system
      - XPACK_SECURITY_HTTP_SSL_ENABLED="true"
      - XPACK_MONITORING_ELASTICSEARCH_PASSWORD=${LOGSTASH_PASSWORD}
      - XPACK_MONITORING_ELASTICSEARCH_SSL_CERTIFICATEAUTHORITY=config/certs/ca/ca.crt
      - XPACK_MONITORING_ELASTICSEARCH_SSL_VERIFICATIONMODE=certificate
      - XPACK_MONITORING_COLLECTION_PIPELINE_DETAILS_ENABLED="true"
```

### Common Problems

**First** is the scheme of the hosts - **MUST NOT INCLUDE THE HTTPS and HTTP**

**Second** is if using the default docker-compose of ElasticSearch Documentation then the permission for logstash must be reconfigure as below (for me
I change it to 777, not the best one but the cheat one)

```bash
echo "Setting File Permission"
chown -R root:root config/certs
find . -type d -exec chmod 777 \{\} \;;
find . -type f -exec chmod 777 \{\} \;;

```

## ELK AWS

### Using Docker Compose and AWS ECS notes

1. Docker Compose need to create a context name ecs (which docker is support)

Using this command ```docker compose ecs <name>```
After that you should change the context to ecs using ```docker compose use <name>```

2. You must download AWS CLI and Config its config and credentials -> Create User in IAM and give it permission to do so
The folder that contain the config is ~/.aws/config and ~/.aws/crendentials

## Process w3wp.exe

Process to look for, could leave to some serious exploit
